<!DOCTYPE html>
<html lang="cs">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scoreboard App</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --panel-bg: #2d2d2d;
            --text-color: #ffffff;
            --accent-green: #4caf50;
            --accent-red: #f44336;
            --accent-yellow: #ffc107;
            --accent-blue: #2196f3;
            --border-radius: 8px;
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            height: 100vh;
            box-sizing: border-box;
            overflow: hidden;
            /* Prevent body scroll if content fits */
        }

        #app-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            height: 100%;
        }

        /* Responsive Layout */
        @media (max-width: 1024px) {
            #app-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
                overflow-y: auto;
            }

            body {
                overflow-y: auto;
                height: auto;
            }
        }

        .panel {
            background-color: var(--panel-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }

        h2,
        h3 {
            margin-top: 0;
            border-bottom: 2px solid #444;
            padding-bottom: 10px;
        }

        /* --- Controls Section (Left Panel) --- */
        #game-controls {
            gap: 20px;
        }

        /* Phase Navigation */
        .phase-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #383838;
            padding: 10px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }

        .phase-steps {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .phase-btn {
            background: #555;
            border: none;
            color: #aaa;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }

        .phase-btn.active {
            background: var(--accent-blue);
            color: white;
            box-shadow: 0 0 10px rgba(33, 150, 243, 0.5);
        }

        .nav-arrow {
            background: #444;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
        }

        .nav-arrow:hover {
            background: #666;
        }

        /* Score & Time Area */
        .scoreboard-interface {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            flex-grow: 1;
            align-items: center;
        }

        .team-panel {
            text-align: center;
            background: #333;
            padding: 20px;
            border-radius: var(--border-radius);
        }

        .team-name {
            font-size: 1.5em;
            margin-bottom: 15px;
            font-weight: bold;
            color: #ddd;
        }

        .score-display {
            font-size: 4em;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
        }

        .score-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .round-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .center-panel {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .timer-display {
            font-size: 5em;
            font-family: 'Courier New', monospace;
            background: #000;
            padding: 10px 30px;
            border-radius: 10px;
            border: 2px solid #444;
            color: var(--accent-yellow);
        }

        .timer-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .small-btn {
            padding: 5px 10px;
            font-size: 0.9em;
            background: #555;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        /* --- Admin Section (Right Panel) --- */
        #admin-panel {
            overflow-y: auto;
        }

        .accordion {
            margin-bottom: 10px;
        }

        .accordion-header {
            background-color: #444;
            padding: 10px;
            cursor: pointer;
            border-radius: 4px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
        }

        .accordion-content {
            padding: 10px;
            background: #383838;
            margin-top: 2px;
            border-radius: 0 0 4px 4px;
            display: none;
        }

        .accordion-content.open {
            display: block;
        }

        .form-group {
            margin-bottom: 10px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #ccc;
        }

        input,
        select {
            width: 100%;
            padding: 8px;
            background: #222;
            border: 1px solid #555;
            color: white;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .btn-full {
            width: 100%;
            padding: 10px;
            background: var(--accent-blue);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }

        .btn-projection {
            background: #9c27b0;
            margin-bottom: 20px;
        }

        /* Color Utilities (must be after layout classes) */
        .btn-green {
            background-color: var(--accent-green) !important;
        }

        .btn-red {
            background-color: var(--accent-red) !important;
        }

        .btn-yellow {
            background-color: var(--accent-yellow) !important;
            color: #000 !important;
        }

        .btn-orange {
            background-color: #ff9800 !important;
            color: white !important;
        }

        /* List Styling */
        .match-list {
            list-style: none;
            padding: 0;
        }

        .match-item {
            background: #444;
            margin-bottom: 5px;
            padding: 8px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
            /* Indicate draggable */
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .match-item.drag-over {
            transform: scale(1.02);
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
            border: 2px dashed #4caf50;
        }

        .active-match {
            border-left: 5px solid var(--accent-green);
            background-color: #3e5e40;
        }

        .editing-match {
            background-color: #8c2a2a !important;
            /* Redish background for edit */
            border: 2px solid #f44336;
        }
    </style>
</head>

<body>

    <div id="app-container">
        <!-- LEFT PANEL: Game Controls -->
        <div id="game-controls" class="panel">
            <button class="btn-full btn-projection" onclick="openProjectionWindow()">üìΩÔ∏è Otev≈ô√≠t Projekƒçn√≠ Okno</button>

            <div class="phase-nav">
                <button class="nav-arrow" onclick="game.step(-1)">‚óÑ</button>
                <div class="phase-steps">
                    <button class="phase-btn" data-phase="0">Nastupuje</button>
                    <button class="phase-btn" data-phase="1">1. Poloƒças</button>
                    <button class="phase-btn" data-phase="2">P≈ôest√°vka</button>
                    <button class="phase-btn" data-phase="3">2. Poloƒças</button>
                </div>
                <button class="nav-arrow" onclick="game.step(1)">‚ñ∫</button>
            </div>

            <div class="scoreboard-interface">
                <!-- Home Team -->
                <div class="team-panel">
                    <div class="team-name" id="home-name-disp">Dom√°c√≠</div>
                    <div class="score-display" id="home-score-disp">0</div>
                    <div class="score-controls">
                        <button class="round-btn btn-green" onclick="game.adjustScore('home', 1)">+</button>
                        <button class="round-btn btn-red" onclick="game.adjustScore('home', -1)">-</button>
                    </div>
                </div>

                <!-- Timer & Center -->
                <div class="center-panel">
                    <div id="match-info-display" style="color:#aaa; margin-bottom:5px; font-weight:bold;">-</div>
                    <div class="timer-display" id="main-timer">00:00</div>
                    <div class="timer-controls">
                        <button id="btn-timer-toggle" class="round-btn btn-yellow"
                            onclick="game.toggleTimer()">‚èØ</button>
                        <button class="round-btn btn-red" onclick="game.resetTimer()">‚Ü∫</button>
                    </div>
                    <div style="display: flex; gap: 5px;">
                        <button class="small-btn" onclick="game.adjustTime(1)">+1s</button>
                        <button class="small-btn" onclick="game.adjustTime(-1)">-1s</button>
                    </div>
                </div>

                <!-- Guest Team -->
                <div class="team-panel">
                    <div class="team-name" id="guest-name-disp">Host√©</div>
                    <div class="score-display" id="guest-score-disp">0</div>
                    <div class="score-controls">
                        <button class="round-btn btn-green" onclick="game.adjustScore('guest', 1)">+</button>
                        <button class="round-btn btn-red" onclick="game.adjustScore('guest', -1)">-</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT PANEL: Administration -->
        <div id="admin-panel" class="panel">
            <h3>Turnajov√° Spr√°va</h3>

            <!-- 1. Tournament Settings -->
            <div class="accordion">
                <div class="accordion-header" onclick="toggleAccordion('acc-settings')">
                    Nastaven√≠ Turnaje <span>‚ñº</span>
                </div>
                <div id="acc-settings" class="accordion-content open">
                    <div class="form-group">
                        <label>N√°zev Turnaje</label>
                        <input type="text" id="input-tournament-name" placeholder="Nap≈ô. Zimn√≠ Poh√°r">
                    </div>
                    <div class="form-group">
                        <label>D√©lka: Nastupuje (s)</label>
                        <input type="number" id="time-setup" value="300" min="0">
                    </div>
                    <div class="form-group">
                        <label>D√©lka: Poloƒças (s)</label>
                        <input type="number" id="time-play" value="1200" min="0">
                    </div>
                    <div class="form-group">
                        <label>D√©lka: P≈ôest√°vka (s)</label>
                        <input type="number" id="time-break" value="600" min="0">
                    </div>
                    <div class="form-group">
                        <label>Seznam Dru≈æstev (oddƒõlen√© ƒç√°rkou)</label>
                        <input type="text" id="input-teams-list" placeholder="Dru≈æstvo A, Dru≈æstvo B, ...">
                    </div>
                    <div class="form-group">
                        <label>Seznam Rozhodƒç√≠ch (oddƒõlen√© ƒç√°rkou)</label>
                        <input type="text" id="input-referees-list" placeholder="Nov√°k, Svoboda, ...">
                    </div>
                    <div class="form-group">
                        <label>Zvukov√° sir√©na (MP3)</label>
                        <input type="file" id="input-audio-file" accept="audio/*">
                        <small style="color:#aaa; display:block; margin-top:5px;">Vyberte kr√°tk√Ω MP3 soubor. Ulo≈æ√≠ se do
                            prohl√≠≈æeƒçe.</small>
                    </div>

                    <button class="btn-full" onclick="admin.saveSettings()">Ulo≈æit nastaven√≠</button>
                    <button class="btn-full btn-red" style="margin-top:10px;" onclick="admin.resetApp()">Resetovat celou
                        aplikaci</button>
                </div>
            </div>



            <!-- 3. Schedule -->
            <div class="accordion">
                <div class="accordion-header" onclick="toggleAccordion('acc-schedule')">
                    Rozpis Z√°pas≈Ø <span>‚ñº</span>
                </div>
                <div id="acc-schedule" class="accordion-content">
                    <button class="btn-full" onclick="admin.toggleScheduleForm()" id="btn-toggle-sched-form"
                        style="margin-bottom:10px; background:#444;">
                        ‚ûï P≈ôidat / Upravit z√°pas
                    </button>

                    <div id="sched-form-container"
                        style="display:none; border:1px solid #444; padding:10px; border-radius:4px; margin-bottom:15px; background:#2a2a2a;">
                        <div class="form-group">
                            <label>N√°zev</label>
                            <select id="sched-title">
                                <option value="Skupina A">Skupina A</option>
                                <option value="Skupina B">Skupina B</option>
                                <option value="Skupina C">Skupina C</option>
                                <option value="Skupina D">Skupina D</option>
                                <option value="ƒåtvrtfin√°le">ƒåtvrtfin√°le</option>
                                <option value="Semifin√°le">Semifin√°le</option>
                                <option value="Fin√°le">Fin√°le</option>
                                <option value="O um√≠stƒõn√≠">O um√≠stƒõn√≠</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Dom√°c√≠</label>
                            <select id="sched-home"></select>
                        </div>
                        <div class="form-group">
                            <label>Host√©</label>
                            <select id="sched-guest"></select>
                        </div>
                        <div class="form-group">
                            <label>Rozhodƒç√≠</label>
                            <select id="sched-referee"></select>
                        </div>
                        <!-- New Score Inputs (Hidden for New, Visible/Populated for Edit) -->
                        <div class="form-group" style="display:flex; gap:10px;">
                            <div style="flex:1">
                                <label>Sk√≥re Dom.</label>
                                <input type="number" id="sched-home-score" placeholder="-" style="width:100%" min="0">
                            </div>
                            <div style="flex:1">
                                <label>Sk√≥re Host.</label>
                                <input type="number" id="sched-guest-score" placeholder="-" style="width:100%" min="0">
                            </div>
                        </div>
                        <div id="sched-controls-add">
                            <button class="btn-full" onclick="admin.addMatch()">Ulo≈æit Nov√Ω Z√°pas</button>
                        </div>
                        <div id="sched-controls-edit" style="display:none; gap:5px; margin-top:10px;">
                            <button class="btn-full btn-green" onclick="admin.saveEditedMatch()">Ulo≈æit Zmƒõny</button>
                            <button class="btn-full btn-red" onclick="admin.deleteMatch()">Smazat</button>
                            <button class="btn-full btn-yellow" onclick="admin.cancelEdit()">Zru≈°it</button>
                        </div>
                    </div>

                    <h4 style="margin-top:15px; border:none;">Seznam:</h4>
                    <ul class="match-list" id="match-queue"></ul>
                </div>
            </div>

        </div>
    </div>

    <!-- SCRIPT LOGIC -->
    <script>
        // --- DATA STRUCTURES ---
        const PHASES = [
            { id: 0, name: "Nastupuje", timeKey: 'setup' },
            { id: 1, name: "1. Poloƒças", timeKey: 'play' },
            { id: 2, name: "P≈ôest√°vka", timeKey: 'break' },
            { id: 3, name: "2. Poloƒças", timeKey: 'play' }
        ];

        let state = {
            tournamentName: "",
            times: { setup: 5 * 60, play: 20 * 60, break: 10 * 60 }, // in seconds
            teams: [],
            referees: [],
            currentMatch: {
                homeName: "Dom√°c√≠",
                guestName: "Host√©",
                homeScore: 0,
                guestScore: 0,
                referee: "",
                phaseIndex: 0 // 0-3
            },
            audioData: null, // Base64 string of the audio file
            timer: {
                running: false,
                timeLeft: 0,
                lastTick: 0
            },
            pendingEditIndex: -1, // Tracks which match is being edited
            schedule: [],
            activeMatchIndex: -1 // Track which match from schedule is active
        };

        // Window reference
        let projectionWindow = null;

        // --- CORE LOGIC CLASS ---
        const game = {
            init: () => {
                admin.loadFromStorage();
                // If we have an active match index, ensure it's highlighted
                ui.renderSchedule();

                // If just loaded and phases are default, maybe don't reset. 
                // But for now, just ensure UI is consistent.
                ui.render();

                // Animation loop for timer
                setInterval(game.tick, 100);
            },

            tick: () => {
                if (!state.timer.running) return;

                const now = Date.now();
                const delta = (now - state.timer.lastTick) / 1000;

                if (delta >= 1) {
                    state.timer.timeLeft -= 1;
                    state.timer.lastTick = now;

                    if (state.timer.timeLeft <= 0) {
                        state.timer.timeLeft = 0;
                        game.toggleTimer(); // Stop at 0

                        // Play signal only for 1. Poloƒças (1) and 2. Poloƒças (3)
                        if (state.currentMatch.phaseIndex === 1 || state.currentMatch.phaseIndex === 3) {
                            game.playSignal();
                        }
                    }

                    ui.updateTimer();
                    game.syncProjection();
                }
            },

            toggleTimer: () => {
                state.timer.running = !state.timer.running;
                if (state.timer.running) {
                    state.timer.lastTick = Date.now();
                }
                ui.updateTimerBtn();
                game.syncProjection();
            },

            resetTimer: () => {
                state.timer.running = false;
                // Reset time based on current phase
                const currentPhase = PHASES[state.currentMatch.phaseIndex];
                state.timer.timeLeft = state.times[currentPhase.timeKey];

                ui.updateTimer();
                ui.updateTimerBtn();
                game.syncProjection();
            },

            adjustTime: (seconds) => {
                state.timer.timeLeft += seconds;
                if (state.timer.timeLeft < 0) state.timer.timeLeft = 0;
                ui.updateTimer();
                game.syncProjection();
            },

            adjustScore: (team, delta) => {
                if (team === 'home') {
                    state.currentMatch.homeScore += delta;
                    if (state.currentMatch.homeScore < 0) state.currentMatch.homeScore = 0;
                } else {
                    state.currentMatch.guestScore += delta;
                    if (state.currentMatch.guestScore < 0) state.currentMatch.guestScore = 0;
                }
                ui.updateScores();
                game.syncProjection();
            },

            step: (direction) => {
                let newPhaseIndex = state.currentMatch.phaseIndex + direction;

                // Moving Forward past last phase -> Next Match
                if (newPhaseIndex >= PHASES.length) {
                    if (game.loadMatchByRelativeIndex(1)) {
                        // Match loaded, phase set inside that function (to 0)
                        return;
                    } else {
                        // No next match, stay at end
                        // BUT still save the result of the current last match!
                        if (state.activeMatchIndex !== -1 && state.schedule[state.activeMatchIndex]) {
                            state.schedule[state.activeMatchIndex].homeScore = state.currentMatch.homeScore;
                            state.schedule[state.activeMatchIndex].guestScore = state.currentMatch.guestScore;
                            ui.renderSchedule();
                            admin.saveToStorage();
                            alert("Konec turnaje (nebo posledn√≠ z√°pas). V√Ωsledek ulo≈æen.");
                        }
                        newPhaseIndex = PHASES.length - 1;
                    }
                }

                // Moving Backward before first phase -> Prev Match
                if (newPhaseIndex < 0) {
                    if (game.loadMatchByRelativeIndex(-1)) {
                        // Match loaded, phase set inside that function (to last)
                        return;
                    } else {
                        newPhaseIndex = 0;
                    }
                }

                if (newPhaseIndex !== state.currentMatch.phaseIndex) {
                    game.setPhase(newPhaseIndex, true);
                }
            },

            setPhase: (index, resetTime) => {
                state.currentMatch.phaseIndex = index;
                if (resetTime) {
                    game.resetTimer();
                }
                ui.renderPhase();
                game.syncProjection();
            },

            // Returns true if match change was successful
            loadMatchByRelativeIndex: (offset) => {
                // Auto-Save Score of currently active match before switching
                if (state.activeMatchIndex !== -1 && state.schedule[state.activeMatchIndex]) {
                    state.schedule[state.activeMatchIndex].homeScore = state.currentMatch.homeScore;
                    state.schedule[state.activeMatchIndex].guestScore = state.currentMatch.guestScore;
                }

                let targetIndex = state.activeMatchIndex;

                // Loop navigation logic
                // If active is -1 (unsaved/manual match), and we go NEXT, start from 0
                if (targetIndex === -1) {
                    if (offset > 0) targetIndex = 0;
                } else {
                    targetIndex += offset;
                }

                // Check bounds
                if (targetIndex >= 0 && targetIndex < state.schedule.length) {
                    admin.loadMatch(targetIndex);
                    // Phase Reset Logic
                    if (offset < 0) {
                        game.setPhase(PHASES.length - 1, true);
                    } else {
                        game.setPhase(0, true);
                    }
                    return true;
                }
                return false;
            },

            syncProjection: () => {
                if (projectionWindow && !projectionWindow.closed) {
                    projectionWindow.postMessage(JSON.parse(JSON.stringify(state)), '*');
                }
            },

            reorderSchedule: (fromIndex, toIndex) => {
                const item = state.schedule.splice(fromIndex, 1)[0];
                state.schedule.splice(toIndex, 0, item);

                // Adjust active match index if needed
                if (state.activeMatchIndex === fromIndex) {
                    state.activeMatchIndex = toIndex;
                } else if (state.activeMatchIndex > fromIndex && state.activeMatchIndex <= toIndex) {
                    state.activeMatchIndex--;
                } else if (state.activeMatchIndex < fromIndex && state.activeMatchIndex >= toIndex) {
                    state.activeMatchIndex++;
                }

                ui.renderSchedule();
                admin.saveToStorage();
            },

            playSignal: () => {
                if (state.audioData) {
                    try {
                        const snd = new Audio(state.audioData);
                        snd.play().catch(e => console.error("Audio play failed:", e));
                    } catch (err) {
                        console.error("Invalid audio data", err);
                    }
                }
            }
        };

        // --- ADMIN HELPERS ---
        const admin = {
            saveSettings: () => {
                state.tournamentName = document.getElementById('input-tournament-name').value;

                state.times.setup = Math.max(0, parseInt(document.getElementById('time-setup').value || 300));
                state.times.play = Math.max(0, parseInt(document.getElementById('time-play').value || 1200));
                state.times.break = Math.max(0, parseInt(document.getElementById('time-break').value || 600));

                const teamsRaw = document.getElementById('input-teams-list').value;
                state.teams = teamsRaw.split(',').map(t => t.trim()).filter(t => t.length > 0);

                const refsRaw = document.getElementById('input-referees-list').value;
                state.referees = refsRaw.split(',').map(t => t.trim()).filter(t => t.length > 0);

                // Handle Audio File
                const fileInput = document.getElementById('input-audio-file');
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    if (file.size > 2 * 1024 * 1024) { // 2MB limit check
                        alert("Soubor je p≈ô√≠li≈° velk√Ω (>2MB). Zvolte men≈°√≠ MP3.");
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        state.audioData = e.target.result;
                        finishSave();
                    };
                    reader.readAsDataURL(file);
                } else {
                    finishSave();
                }

                function finishSave() {
                    admin.saveToStorage();
                    ui.fillSelects();
                    game.resetTimer(); // Apply new times
                    alert("Nastaven√≠ ulo≈æeno.");
                }
            },

            resetApp: () => {
                if (confirm("Opravdu chcete vymazat v≈°echna data aplikace (t√Ωmy, rozpis, zvuk)? Tuto akci nelze vz√≠t zpƒõt.")) {
                    localStorage.removeItem('scoreboardState');
                    location.reload();
                }
            },

            updateCurrentMatch: () => {
                // Manually updating from input fields is deprecated as fields were removed.
                // Keeping function stub if needed for future logic, or removing.
                // For now, let's just sync projection if called.
                ui.updateNames();
                game.syncProjection();
            },

            addMatch: () => {
                const match = {
                    title: document.getElementById('sched-title').value,
                    home: document.getElementById('sched-home').value,
                    guest: document.getElementById('sched-guest').value,
                    referee: document.getElementById('sched-referee').value
                };
                state.schedule.push(match);
                admin.clearSchedInputs();
                admin.toggleScheduleForm(false); // Hide after add
                ui.renderSchedule();
                admin.saveToStorage();
            },

            toggleScheduleForm: (forceShow) => {
                const f = document.getElementById('sched-form-container');
                const btn = document.getElementById('btn-toggle-sched-form');

                let show = forceShow !== undefined ? forceShow : (f.style.display === 'none');

                f.style.display = show ? 'block' : 'none';
                btn.innerHTML = show ? '‚ûñ Zav≈ô√≠t formul√°≈ô' : '‚ûï P≈ôidat / Upravit z√°pas';

                if (show && state.pendingEditIndex === -1) {
                    admin.clearSchedInputs();
                }
            },

            editScheduleMatch: (index) => {
                state.pendingEditIndex = index;
                const m = state.schedule[index];
                document.getElementById('sched-title').value = m.title;
                document.getElementById('sched-home').value = m.home;
                document.getElementById('sched-guest').value = m.guest;
                document.getElementById('sched-referee').value = m.referee;
                document.getElementById('sched-home-score').value = (m.homeScore !== undefined && m.homeScore !== null) ? m.homeScore : "";
                document.getElementById('sched-guest-score').value = (m.guestScore !== undefined && m.guestScore !== null) ? m.guestScore : "";

                // Toggle buttons
                document.getElementById('sched-controls-add').style.display = 'none';
                document.getElementById('sched-controls-edit').style.display = 'flex';

                // Ensure form section is open
                admin.toggleScheduleForm(true);

                // Open accordion if closed
                const acc = document.getElementById('acc-schedule');
                if (!acc.classList.contains('open')) acc.classList.add('open');
            },

            saveEditedMatch: () => {
                if (state.pendingEditIndex > -1) {
                    let hScore = document.getElementById('sched-home-score').value;
                    let gScore = document.getElementById('sched-guest-score').value;

                    // Validation: Ensure non-negative
                    let parsedH = hScore !== "" ? parseInt(hScore) : null;
                    let parsedG = gScore !== "" ? parseInt(gScore) : null;

                    if (parsedH !== null && parsedH < 0) parsedH = 0;
                    if (parsedG !== null && parsedG < 0) parsedG = 0;

                    state.schedule[state.pendingEditIndex] = {
                        title: document.getElementById('sched-title').value,
                        home: document.getElementById('sched-home').value,
                        guest: document.getElementById('sched-guest').value,
                        referee: document.getElementById('sched-referee').value,
                        homeScore: parsedH,
                        guestScore: parsedG
                    };
                    admin.cancelEdit(); // Reset UI
                    ui.renderSchedule();
                    admin.saveToStorage();
                    admin.toggleScheduleForm(false); // Hide
                }
            },

            deleteMatch: () => {
                if (state.pendingEditIndex > -1 && confirm("Opravdu smazat tento z√°pas?")) {
                    state.schedule.splice(state.pendingEditIndex, 1);
                    // Adjust active index if needed
                    if (state.activeMatchIndex === state.pendingEditIndex) state.activeMatchIndex = -1;
                    else if (state.activeMatchIndex > state.pendingEditIndex) state.activeMatchIndex--;

                    admin.cancelEdit();
                    ui.renderSchedule();
                    admin.saveToStorage();
                    admin.toggleScheduleForm(false); // Hide
                }
            },

            cancelEdit: () => {
                state.pendingEditIndex = -1;
                ui.renderSchedule(); // Re-render to clear highlights
                admin.clearSchedInputs();
                document.getElementById('sched-controls-add').style.display = 'block';
                document.getElementById('sched-controls-edit').style.display = 'none';
                admin.toggleScheduleForm(false); // Hide
            },

            clearSchedInputs: () => {
                // Reset select to first option or empty? 
                // Let's keep dropdowns, but maybe reset teams to empty
                document.getElementById('sched-title').selectedIndex = 0;
                document.getElementById('sched-home').value = "";
                document.getElementById('sched-guest').value = "";
                document.getElementById('sched-referee').value = "";
                document.getElementById('sched-home-score').value = "";
                document.getElementById('sched-guest-score').value = "";

                // CRITIAL FIX: Ensure dropdowns are populated if empty (e.g. after refresh)
                // We check if they have options. If not, fill them.
                if (document.getElementById('sched-home').options.length <= 1) {
                    ui.fillSelects();
                }
            },

            moveMatch: (from, to) => {
                game.reorderSchedule(from, to);
            },

            loadMatch: (index, resetPhase = false) => {
                const m = state.schedule[index];
                state.activeMatchIndex = index;
                state.currentMatch.homeName = m.home;
                state.currentMatch.guestName = m.guest;
                state.currentMatch.homeScore = 0;
                state.currentMatch.guestScore = 0;

                state.currentMatch.guestScore = 0;

                // Removed update of select-home-team etc since they are deleted from DOM.

                ui.updateNames();
                ui.updateScores();
                ui.updateScores();
                ui.renderSchedule(); // update active highlight

                if (resetPhase) {
                    game.setPhase(0, true);
                }
            },

            saveToStorage: () => {
                localStorage.setItem('scoreboardState', JSON.stringify(state));
            },

            loadFromStorage: () => {
                const loaded = localStorage.getItem('scoreboardState');
                if (loaded) {
                    const parsed = JSON.parse(loaded);
                    state.tournamentName = parsed.tournamentName || "";
                    if (parsed.times) state.times = parsed.times;
                    if (parsed.teams) state.teams = parsed.teams;
                    if (parsed.referees) state.referees = parsed.referees;
                    if (parsed.schedule) state.schedule = parsed.schedule;
                    if (typeof parsed.activeMatchIndex !== 'undefined') state.activeMatchIndex = parsed.activeMatchIndex;
                    if (parsed.audioData) state.audioData = parsed.audioData;
                }

                // Set Inputs
                document.getElementById('input-tournament-name').value = state.tournamentName;
                document.getElementById('time-setup').value = state.times.setup;
                document.getElementById('time-play').value = state.times.play;
                document.getElementById('time-break').value = state.times.break;
                document.getElementById('input-teams-list').value = state.teams.join(', ');
                document.getElementById('input-referees-list').value = (state.referees || []).join(', ');

                ui.fillSelects();
                ui.renderSchedule();
            }
        };

        // --- UI DRAWING ---
        const ui = {
            render: () => {
                ui.renderPhase();
                ui.updateScores();
                ui.updateNames();
                ui.updateTimer();
                ui.updateTimerBtn();
                ui.renderSchedule();
            },

            renderPhase: () => {
                document.querySelectorAll('.phase-btn').forEach(btn => {
                    btn.classList.toggle('active', parseInt(btn.dataset.phase) === state.currentMatch.phaseIndex);
                });
                ui.updateMatchInfo(); // Also update info when rendering phase (or general render)
            },

            updateMatchInfo: () => {
                const infoDiv = document.getElementById('match-info-display');
                if (state.activeMatchIndex > -1 && state.schedule[state.activeMatchIndex]) {
                    const m = state.schedule[state.activeMatchIndex];
                    infoDiv.textContent = `#${state.activeMatchIndex + 1} ${m.title || ""}`;
                } else {
                    infoDiv.textContent = state.tournamentName || "Z√°pas";
                }
            },

            updateScores: () => {
                document.getElementById('home-score-disp').textContent = state.currentMatch.homeScore;
                document.getElementById('guest-score-disp').textContent = state.currentMatch.guestScore;
            },

            updateNames: () => {
                document.getElementById('home-name-disp').textContent = state.currentMatch.homeName;
                document.getElementById('guest-name-disp').textContent = state.currentMatch.guestName;
            },

            updateTimer: () => {
                const m = Math.floor(state.timer.timeLeft / 60).toString().padStart(2, '0');
                const s = Math.floor(state.timer.timeLeft % 60).toString().padStart(2, '0');
                document.getElementById('main-timer').textContent = `${m}:${s}`;
            },

            updateTimerBtn: () => {
                const btn = document.getElementById('btn-timer-toggle');
                if (state.timer.running) {
                    btn.textContent = "‚è∏"; // Pause
                    btn.classList.remove('btn-green');
                    btn.classList.add('btn-orange'); // Visual indicator paused/active
                } else {
                    btn.textContent = "‚ñ∂"; // Play
                    btn.classList.remove('btn-orange');
                    btn.classList.remove('btn-yellow');
                    btn.classList.add('btn-green');
                }
            },

            fillSelects: () => {
                // Teams
                const teamSelects = ['sched-home', 'sched-guest'];
                teamSelects.forEach(id => {
                    const sel = document.getElementById(id);
                    if (!sel) return;
                    const currentVal = sel.value;
                    sel.innerHTML = '<option value="">-- Vyber Dru≈æstvo --</option>';
                    state.teams.forEach(t => {
                        sel.innerHTML += `<option value="${t}">${t}</option>`;
                    });
                    // Only restore value if it still exists in the list or is empty
                    if (state.teams.includes(currentVal) || currentVal === "") sel.value = currentVal;
                });

                // Referees
                const refSelects = ['sched-referee'];
                refSelects.forEach(id => {
                    const sel = document.getElementById(id);
                    if (!sel) return;
                    const currentVal = sel.value;
                    sel.innerHTML = '<option value="">-- Vyber Rozhodƒç√≠ho --</option>';
                    state.referees.forEach(r => {
                        sel.innerHTML += `<option value="${r}">${r}</option>`;
                    });
                    if (state.referees.includes(currentVal) || currentVal === "") sel.value = currentVal;
                });
            },

            renderSchedule: () => {
                const list = document.getElementById('match-queue');
                list.innerHTML = "";
                state.schedule.forEach((m, idx) => {
                    const li = document.createElement('li');
                    li.className = "match-item";
                    li.draggable = true;
                    li.dataset.index = idx;
                    li.title = "Dvojklik pro editaci, Ta≈æen√≠m zmƒõ≈à po≈ôad√≠";

                    // Double Click to Edit
                    li.addEventListener('dblclick', (e) => {
                        // Prevent triggering if clicking the "Naƒç√≠st" button inside
                        if (!e.target.classList.contains('small-btn')) {
                            admin.editScheduleMatch(idx);
                            ui.renderSchedule(); // Update highlights
                        }
                    });

                    // Drag Events
                    li.addEventListener('dragstart', (e) => {
                        e.dataTransfer.effectAllowed = 'move';
                        e.dataTransfer.setData('text/plain', idx);
                        li.style.opacity = '0.5';
                    });

                    li.addEventListener('dragend', (e) => {
                        li.style.opacity = '1';
                        // Remove dragover styles from all
                        document.querySelectorAll('.match-item').forEach(item => item.classList.remove('drag-over'));
                    });

                    li.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        e.dataTransfer.dropEffect = 'move';
                        li.classList.add('drag-over');
                    });

                    li.addEventListener('dragleave', (e) => {
                        li.classList.remove('drag-over');
                    });

                    li.addEventListener('drop', (e) => {
                        e.preventDefault();
                        const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
                        const toIndex = idx;

                        if (fromIndex !== toIndex) {
                            admin.moveMatch(fromIndex, toIndex);
                        }
                    });

                    if (idx === state.activeMatchIndex) {
                        li.classList.add('active-match');
                    }
                    if (idx === state.pendingEditIndex) {
                        li.classList.add('editing-match');
                    }
                    let scoreDisplay = "";
                    if (m.homeScore !== undefined && m.homeScore !== null && m.guestScore !== undefined && m.guestScore !== null) {
                        scoreDisplay = `<br><b>${m.homeScore} : ${m.guestScore}</b>`;
                    }

                    li.innerHTML = `
                        <div>
                            <b>#${idx + 1} ${m.title}</b><br>
                            ${m.home} vs ${m.guest}<br>
                            <small>Rozhodƒç√≠: ${m.referee || '-'}</small>
                            ${scoreDisplay}
                        </div>
                        <button class="small-btn" onclick="admin.loadMatch(${idx}, true)">Naƒç√≠st</button>
                    `;
                    list.appendChild(li);
                });
            }
        };

        // --- UTILS ---
        function toggleAccordion(id) {
            const content = document.getElementById(id);
            if (content.classList.contains('open')) {
                content.classList.remove('open');
            } else {
                content.classList.add('open');
                // Force render if schedule is opened to ensure it is up to date/visible
                if (id === 'acc-schedule') {
                    ui.renderSchedule();
                }
            }
        }

        function openProjectionWindow() {
            if (projectionWindow && !projectionWindow.closed) {
                projectionWindow.focus();
                return;
            }

            // Create window
            projectionWindow = window.open("", "ScoreboardProjection", "width=800,height=600");

            // Generate content
            if (projectionWindow) {
                const doc = projectionWindow.document;
                doc.open();
                doc.write(`
                    <!DOCTYPE html>
                    <html lang="cs">
                    <head>
                    <meta charset="UTF-8">
                    <title>Projection</title>
                    <style>
                        body { 
                            background: #000; color: white; display: flex; 
                            flex-direction: column; align-items: center; justify-content: center;
                            height: 100vh; margin: 0; font-family: sans-serif; overflow: hidden;
                        }
                        #header-phase { font-size: 3vw; color: #888; margin-bottom: 2vh; text-transform: uppercase; }
                        #teams-box { display: flex; justify-content: space-around; width: 100%; align-items: center; }
                        .team { text-align: center; width: 40%; }
                        .t-name { font-size: 5vw; font-weight: bold; margin-bottom: 1vh;}
                        .t-score { font-size: 15vw; font-weight: bold; color: #4caf50; line-height: 1;}
                        #timer { font-size: 12vw; font-family: monospace; color: #ffc107; margin-top: 5vh; border: 1vw solid #333; padding: 0 4vw; border-radius: 2vw; background: #111;}
                    </style>
                    </head>
                    <body>
                        <div id="header-phase">...</div>
                        <div id="teams-box">
                            <div class="team">
                                <div class="t-name" id="p-home-name">DOM√ÅC√ç</div>
                                <div class="t-score" id="p-home-score">0</div>
                            </div>
                            <div class="team">
                                <div class="t-name" id="p-guest-name">HOST√â</div>
                                <div class="t-score" id="p-guest-score">0</div>
                            </div>
                        </div>
                        <div id="timer">00:00</div>

                        <script>
                            window.addEventListener('message', (event) => {
                                const state = event.data;
                                const PHASES = ["Nastupuje", "1. Poloƒças", "P≈ôest√°vka", "2. Poloƒças"];
                                
                                document.getElementById('header-phase').innerText = PHASES[state.currentMatch.phaseIndex] || "";
                                document.getElementById('p-home-name').innerText = state.currentMatch.homeName;
                                document.getElementById('p-guest-name').innerText = state.currentMatch.guestName;
                                document.getElementById('p-home-score').innerText = state.currentMatch.homeScore;
                                document.getElementById('p-guest-score').innerText = state.currentMatch.guestScore;
                                
                                const m = Math.floor(state.timer.timeLeft / 60).toString().padStart(2, '0');
                                const s = Math.floor(state.timer.timeLeft % 60).toString().padStart(2, '0');
                                document.getElementById('timer').innerText = m + ":" + s;
                            });
                        <\/script>
                    </body>
                    </html>
                `);
                doc.close();

                // Initial Sync
                game.syncProjection();
            } else {
                alert("Vyskakovac√≠ okno bylo zablokov√°no. Pros√≠m povolte jej pro tuto str√°nku.");
            }
        }

        // --- INIT ---
        window.addEventListener('load', game.init);

    </script>
</body>

</html>